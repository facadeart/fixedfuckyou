---
const { caption, cssClass, index, site, src, total, type = 'image' } = Astro.props

// A random string with the syntax '[a-z][0-9]{3}-index-total'
const key = Math.random().toString(36).slice(2, 6) + '-' + index + '/' + total
---

<a-work class={cssClass} data-type={type}>
  <div class="a__inner">
    <a href={site} target="_blank">
      {type === 'image' ? (
        <img
          src={src}
          alt={caption}
          class="a__image js-image"
          loading="eager"
          decoding="async"
          fetchpriority="high"
          width="1082"
          height="636"
        />
      ) : (
        <video
          data-src={src}
          class="a__video js-video"
          loop
          muted
          playsinline
          width="1082"
          height="636"
        >
        </video>
      )}

      <div class="a__caption">
        <div class="a__caption__text">
          {caption}
        </div><!-- .a__caption__text -->

        <div class="a__caption__key">
          #{key}
        </div><!-- .a__caption__key -->
      </div><!-- .a__caption -->
    </a>
  </div><!-- .a__inner -->
</a-work>

<script>
  class AWork extends HTMLElement {
    static observedAttributes = ['progress']

    link: HTMLAnchorElement
    video: HTMLVideoElement | null
    image: HTMLImageElement | null
    type: string

    isInView: boolean

    /**
     * Init
     */
    connectedCallback() {
      // Elements
      this.video = this.querySelector('.js-video')
      this.image = this.querySelector('.js-image')
      this.link = this.querySelector('a')
      this.type = this.dataset.type || 'image'

      // Properties
      this.isInView = false

      // Events
      this.link.addEventListener('click', this.onClick.bind(this))
    }

    /**
     * Attribute changed
     */
    attributeChangedCallback(name, oldValue, newValue) {
      if (name === 'progress') {
        this.style.setProperty('--progress', newValue)

        if (newValue === '1' || newValue === '-1') {
          if (this.isInView) {
            this.outView()
          }
        } else {
          if (!this.isInView) {
            this.inView()
          }
        }
      }
    }

    /**
     * Gets in view
     */
    inView() {
      if (this.type === 'video' && this.video) {
        this.video.play()
      }
      this.isInView = true

      this.classList.add('is-inview')
    }

    /**
     * Gets out view
     */
    outView() {
      if (this.type === 'video' && this.video) {
        this.video.pause()
      }
      this.isInView = false

      this.classList.remove('is-inview')
    }

    /**
     * On click
     */
    onClick(event: MouseEvent) {
      if (this.link.href.includes('#')) {
        event.preventDefault()
        return false
      }
    }
  }

  customElements.define('a-work', AWork)
</script>

<style lang="scss">
  a-work {
    position: relative;
    top: 0;
    left: 0;

    display: block;
    margin: 0;
    padding: 0.5rem 0.5rem 0;

    background: color(secondary);
    content-visibility: hidden;

    transform-style: preserve-3d;

    will-change: transform;

    @include mq(phone) {
      padding: 0.25rem;
    }

    a {
      display: block;

      text-decoration: none;
    }

    .a__inner {
      display: block;
      margin: 0;
      padding: 0;
    }

    .a__video,
    .a__image {
      display: block;

      width: 100%;
      min-width: 300px;
      max-width: 50vw;
      height: auto;
      min-height: 200px;
      max-height: 50vh;
      object-fit: contain;
      background-color: #1a1a1a;

      @include mq(phone) {
        min-width: 250px;
        max-width: 80vw;
        min-height: 150px;
        max-height: 80vh;
      }
    }

    .a__caption {
      @include flex(row, center, space-between);

      padding: 0.5rem 0.5rem;

      color: color(primary);
      font: 700 11px / 1 font-family(fraktion);
      letter-spacing: 0.15em;
      text-align: right;
      text-transform: uppercase;

      @include mq(phone) {
        display: none;
      }
    }

    &.is-inview {
      content-visibility: visible;
    }
  }
</style>
